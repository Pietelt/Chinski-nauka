<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#d32f2f">
<title>Nauka chi≈Ñskiego ‚Äì tryb tematyczny</title>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin-top: 40px;
}

.hanzi {
    font-size: 64px;
    font-weight: bold;
    margin-top: 30px;
}

.pinyin {
    font-size: 26px;
    margin-top: 10px;
}

.pl {
    font-size: 20px;
    color: #444;
    margin-top: 10px;
}

#topicSelect {
    min-width: 220px;
    border-radius: 10px;
    padding: 6px;
}

#answer {
    display: none;
}

select, button {
    padding: 8px 15px;
    font-size: 16px;
    margin: 10px;
}
.answer-layout {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 30px;
    align-items: start;

    /* üîΩ TO JEST KLUCZ */
    max-width: 900px;
    margin: 30px auto 0 auto;

    background: #fafafa;
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
}

.answer-text {
    text-align: center;
}

#stroke-container {
    display: none;
}

#stroke-iframe {
    width: 100%;
    height: 420px;
    border: 1px solid #ccc;
    border-radius: 12px;
}

/* RESPONSYWNO≈öƒÜ */
@media (max-width: 900px) {
    .answer-layout {
        grid-template-columns: 1fr;
    }

    #stroke-iframe {
        height: 360px;
    }
}
#components {
    text-align: left;
    margin-top: 20px;
}

#components-list {
    display: grid;
    gap: 12px;
}

.component {
    display: flex;
    gap: 12px;
    align-items: center;
    background: #fff;
    padding: 10px 14px;
    border-radius: 10px;
    border-left: 4px solid #e53935;
}

.component-char {
    font-size: 32px;
    font-weight: bold;
}

.component-desc {
    font-size: 15px;
}
iframe {
  width: 100%;
  height: 300px;
}

#menuButton {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 22px;
    padding: 6px 12px;
    border-radius: 10px;
    border: none;
    background: #333;
    color: white;
    cursor: pointer;
    z-index: 1000;
}

#menuPanel {
    position: fixed;
    top: 50px;
    right: 10px;
    width: 220px;
    background: white;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    z-index: 999;
}

#menuPanel.hidden {
    display: none;
}

.menu-option {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
}
#draw-section {
    text-align: center;
}

#draw-canvas {
    margin-top: 10px;
}
#draw-canvas {
    border: 2px solid #ccc;
    background: #fff;
    touch-action: none;
    pointer-events: auto;
}


</style>
</head>

<body>

<!-- MENU BUTTON -->
<button id="menuButton">‚ò∞</button>

<!-- MENU PANEL -->
<div id="menuPanel" class="hidden">
    <label class="menu-option">
        <input type="checkbox" id="autoTtsToggle">
        üîä Automatyczne TTS
        <input type="checkbox" id="toggleDraw" onchange="toggleDrawSection()">
        Pole do rysowania
    </label>
</div>

<h1>Nauka chi≈Ñskiego üá®üá≥</h1>

<label>Tematy (mo≈ºna wybraƒá kilka):</label><br>
<select id="topicSelect" multiple size="6">
</select>

<br>

<label for="startMode">PoczƒÖtkowo pokazuj:</label>
<select id="startMode">
    <option value="hanzi">Hanzi</option>
    <option value="hanzi-missing">Hanzi ‚Äì brakujƒÖcy znak</option>
    <option value="pinyin">Pinyin</option>
    <option value="pl">Polskie t≈Çumaczenie</option>
    <option value="random">Losowo</option>
</select>

<br>

<button onclick="draw()">Losuj</button>
<button onclick="showAnswer()">Poka≈º odpowied≈∫</button>
<button onclick="speak()">üîä Wym√≥w</button>

<div id="question" class="hanzi"></div>

    <!-- SEKCJA RYSOWANIA -->
    <div id="draw-section" style="display:none; margin-top:30px;">
        <h3>‚úçÔ∏è ƒÜwicz pisanie</h3>

        <canvas
            id="draw-canvas"
            width="300"
            height="300"
            style="
                border:2px solid #ccc;
                border-radius:12px;
                background:white;
                touch-action:none;
            ">
        </canvas>

        <br>
        <button onclick="clearCanvas()">Wyczy≈õƒá</button>
    </div>

<div id="answer">
    <div class="answer-layout">

        <!-- LEWA STRONA ‚Äì TEKST -->
        <div class="answer-text">
            <div id="ans-hanzi" class="hanzi"></div>
            <div id="ans-pinyin" class="pinyin"></div>
            <div id="ans-pl" class="pl"></div>
            <div id="components" style="margin-top:20px; display:none;">
                <h3>Budowa znaku</h3>
                <div id="components-list"></div>
            </div>
        </div>

        <!-- PRAWA STRONA ‚Äì ANIMACJA -->
        <div id="stroke-container">
            <iframe
                id="stroke-iframe"
                loading="lazy">
            </iframe>
        </div>

    </div>
    

</div>

<script>
let missingIndex = null;
let words = [];
let filteredWords = [];
let currentWord = null;
let questionType = null;

const STORAGE_KEY = "wordStats";
let stats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
let lastWordId = null;

fetch("data.json")
    .then(res => res.json())
    .then(data => {
        words = data.map((w, i) => ({
            ...w,
            _id: `${w.hanzi}_${i}`
        }));

        // inicjalizacja statystyk
        words.forEach(w => {
            if (!stats[w._id]) stats[w._id] = 0;
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));

        setupTopics();
        filteredWords = words;
    });

function setupTopics() {
    const select = document.getElementById("topicSelect");
    const topics = [...new Set(words.map(w => w.topic))];

    topics.forEach(topic => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic;
        select.appendChild(option);
    });

    select.addEventListener("change", updateFilteredWords);

}

function updateFilteredWords() {
    const select = document.getElementById("topicSelect");

    const selectedTopics = Array.from(select.selectedOptions)
        .map(opt => opt.value);

    if (selectedTopics.length === 0 || selectedTopics.includes("all")) {
        filteredWords = words;
    } else {
        filteredWords = words.filter(w =>
            selectedTopics.includes(w.topic)
        );
    }
}

function draw() {
    // üîΩ ZAWSZE chowamy odpowied≈∫
    document.getElementById("answer").style.display = "none";

    // (opcjonalnie) czy≈õcimy zawarto≈õƒá odpowiedzi
    document.getElementById("ans-hanzi").textContent = "";
    document.getElementById("ans-pinyin").textContent = "";
    document.getElementById("ans-pl").textContent = "";

    // je≈ºeli masz pole do rysowania ‚Äì czy≈õcimy je
    clearCanvas?.();
    
    if (filteredWords.length === 0) return;

    // usuwamy ostatnie s≈Çowo z puli (brak powt√≥rze≈Ñ)
    const pool = filteredWords.filter(w => w._id !== lastWordId);

    // znajd≈∫ minimum losowa≈Ñ
    const minCount = Math.min(...pool.map(w => stats[w._id] || 0));

    // im rzadziej losowane, tym wiƒôksza waga
    const weightedPool = [];
    pool.forEach(w => {
        const weight = (minCount + 3) - (stats[w._id] || 0);
        for (let i = 0; i < Math.max(1, weight); i++) {
            weightedPool.push(w);
        }
    });

    const mode = document.getElementById("startMode").value;

// üîπ TRYB: BRAKUJƒÑCY ZNAK
if (mode === "hanzi-missing") {
    const multiCharWords = filteredWords.filter(
        w => w.hanzi && w.hanzi.length >= 2
    );

    if (multiCharWords.length === 0) {
        alert("Brak s≈Ç√≥w z≈Ço≈ºonych z 2+ znak√≥w");
        return;
    }

    currentWord = multiCharWords[Math.floor(Math.random() * multiCharWords.length)];

    // losowy znak do ukrycia
    missingIndex = Math.floor(Math.random() * currentWord.hanzi.length);

    const chars = currentWord.hanzi.split("");
    chars[missingIndex] = "‚òê";

    questionType = "hanzi-missing";
    document.getElementById("question").textContent = chars.join("");

} else {
    // üîπ NORMALNE TRYBY (jak by≈Ço)
    currentWord = weightedPool[Math.floor(Math.random() * weightedPool.length)];

    questionType =
        mode === "random"
            ? ["hanzi", "pinyin", "pl"][Math.floor(Math.random() * 3)]
            : mode;

    document.getElementById("question").textContent = currentWord[questionType];
}


        // poka≈º pole rysowania, je≈õli w≈ÇƒÖczone w menu
    const drawToggle = document.getElementById("toggleDraw");
    const drawSection = document.getElementById("draw-section");

    if (drawToggle && drawToggle.checked) {
        drawSection.style.display = "block";
    }   

    // zawsze czy≈õƒá canvas przy nowym losowaniu
    clearCanvas();


}

function showAnswer() {
    if (!currentWord) return;

    // Czy≈õcimy pola
    document.getElementById("ans-hanzi").textContent = "";
    document.getElementById("ans-pinyin").textContent = "";
    document.getElementById("ans-pl").textContent = "";

    // Pokazujemy tylko to, co NIE by≈Ço pytaniem
    if (questionType !== "hanzi") {
        document.getElementById("ans-hanzi").textContent = currentWord.hanzi;
    }

    if (questionType !== "pinyin") {
        document.getElementById("ans-pinyin").textContent = currentWord.pinyin;
    }

    if (questionType !== "pl") {
        document.getElementById("ans-pl").textContent = currentWord.pl;
    }

    // IFRAME ‚Äì kolejno≈õƒá pisania
    const iframe = document.getElementById("stroke-iframe");
    const container = document.getElementById("stroke-container");

    if (currentWord.hanzi && currentWord.hanzi.length <= 2) {
        const hanziForURL = encodeURIComponent(currentWord.hanzi.trim());
        iframe.src = `https://www.writechinese.com/en/hanzi/${hanziForURL}`;
        container.style.display = "block";
    } else {
        iframe.src = "";
        container.style.display = "none";
    }

    if (autoTtsEnabled && questionType !== "pl") {
    setTimeout(speak, 300);
    }

    document.getElementById("answer").style.display = "block";

    // ===== KOMPONENTY ZNAKU =====
const componentsBox = document.getElementById("components");
const componentsList = document.getElementById("components-list");

componentsList.innerHTML = "";

if (currentWord.components && currentWord.components.length > 0) {
    currentWord.components.forEach(c => {
        const div = document.createElement("div");
        div.className = "component";
        div.innerHTML = `
            <div class="component-char">${c.char}</div>
            <div class="component-desc">
                <strong>${c.meaning}</strong><br>
                <small>${c.note || ""}</small>
            </div>
        `;
        componentsList.appendChild(div);
    });

    componentsBox.style.display = "block";
} else {
    componentsBox.style.display = "none";
}

}

function speak() {
    if (!currentWord) return;

    // TTS tylko dla hanzi i pinyin
    if (questionType === "pl") {
        alert("TTS dzia≈Ça tylko dla hanzi lub pinyin");
        return;
    }

    const text =
        questionType === "hanzi"
            ? currentWord.hanzi
            : currentWord.pinyin;

    if (!text) return;

    // zatrzymaj poprzednie czytanie
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "zh-CN";
    utterance.rate = 0.9;
    utterance.pitch = 1;

    // wyb√≥r chi≈Ñskiego g≈Çosu (je≈õli dostƒôpny)
    const voices = speechSynthesis.getVoices();
    const zhVoice = voices.find(v =>
        v.lang.startsWith("zh")
    );

    if (zhVoice) {
        utterance.voice = zhVoice;
    }

    window.speechSynthesis.speak(utterance);
}

speechSynthesis.onvoiceschanged = () => {
    speechSynthesis.getVoices();
};

const menuButton = document.getElementById("menuButton");
const menuPanel = document.getElementById("menuPanel");
const autoTtsToggle = document.getElementById("autoTtsToggle");

// toggle menu
menuButton.addEventListener("click", () => {
    menuPanel.classList.toggle("hidden");
});

// load TTS setting
let autoTtsEnabled = localStorage.getItem("autoTtsEnabled") === "true";
autoTtsToggle.checked = autoTtsEnabled;

// save TTS setting
autoTtsToggle.addEventListener("change", () => {
    autoTtsEnabled = autoTtsToggle.checked;
    localStorage.setItem("autoTtsEnabled", autoTtsEnabled);
});

function toggleDrawSection() {
    const section = document.getElementById("draw-section");
    const checkbox = document.getElementById("toggleDraw");

    section.style.display = checkbox.checked ? "block" : "none";
}

console.log("Wybrane tematy:", selectedTopics);
console.log("Ilo≈õƒá s≈Ç√≥w:", filteredWords.length);

</script>

<script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("Service Worker zarejestrowany"))
        .catch(err => console.error("SW error:", err));
    }
    </script>    
    <script src="script.js"></script>
</body>
</html>
